<!DOCTYPE html>
<html lang="en" data-layout="section">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="T8 SDK Factory: Schema-based validation">
  <title>Schema-based validation | T8 SDK Factory</title>
  <link rel="stylesheet" href="https://unpkg.com/@t8/docsgen@0.3/dist/css/base.css">
  <link rel="stylesheet" href="https://unpkg.com/@t8/docsgen@0.3/dist/css/section.css">
  <link rel="icon" type="image/png" href="/assets/t8.png">
  <link rel="prefetch" href="/sdk-factory/x/Custom_request_handler">
</head>
<body>
<div class="layout">
<div class="body">
<main>
<h1><a href="/sdk-factory/">T8 SDK Factory</a></h1>
<h2>Schema-based validation</h2>
<p>Fine-grained schema-based validation of the request and response can be implemented with a custom request handler. Here's how the basic JSON request handler from the <a href="/sdk-factory/x/Custom_request_handler">previous section</a> can be modified to validate its input and output with Zod or, similarly, with another validation lib:</p>
<pre><code class="language-diff">  import {
    RequestHandler,
    RequestError,
    RequestService,
    getRequestAction,
    toStringValueMap,
  } from "@t8/sdk-factory";
- import type { APISchema } from "./APISchema";
+ import { apiSchema, type APISchema } from "./apiSchema"; // defined with Zod

  function getRequestHandler(endpoint: string): RequestHandler {
    return async function(target, request) {
+     try {
+       schema[target]?.request?.parse(request);
+     }
+     catch {
+       throw new RequestError({ statusText: "Invalid request data" });
+     }

      let { method, url } = getRequestAction({ request, target, endpoint });

      let response = await fetch(url, {
        method,
        headers: toStringValueMap(request?.headers),
        body: request?.body ? JSON.stringify(request?.body) : null,
      });

      let { ok, status, statusText } = response;

      if (!ok) throw new RequestError({ status, statusText });

      try {
        let body = await response.json();

+       try {
+         schema[target]?.response?.parse(body);
+       }
+       catch {
+         throw new RequestError({ statusText: "Invalid response data" });
+       }

        return { ok, status, statusText, body };
      }
      catch (error) {
        throw new RequestError(error);
      }
    };
  }

  export const serverService = new RequestService&lt;APISchema&gt;(
    getRequestHandler("https://api.example.com")
  );

  // Assuming that the given API is proxied by the server to
  // the browser via `/api`
  export const browserService = new RequestService&lt;APISchema&gt;(
    getRequestHandler("/api")
  );
</code></pre>
<p>Here's an example of what the API schema definition with a validation library may look like:</p>
<pre><code class="language-ts">import { z } from "zod";

export const apiSchema = {
  "GET /items/:id": {
    request: z.object({
      params: z.object({
        id: z.coerce.number(),
      }),
      query: z.optional(
        z.object({
          mode: z.optional(z.string()),
        })
      ),
    }),
    response: z.object({
      id: z.coerce.number(),
      name: z.optional(z.string()),
    }),
  },
};

export type APISchema = {
  [K1 in keyof typeof apiSchema]: {
    [K2 in keyof (typeof apiSchema)[K1]]: z.infer&lt;(typeof apiSchema)[K1][K2]&gt;;
  };
};
</code></pre>
<p class="pagenav">
  <span class="prev">
    <span class="icon">←</span>
    <a href="/sdk-factory/x/Custom_request_handler">Custom request handler</a>
  </span>
  <span class="sep">|</span>
  <span class="repo next"><a href="https://github.com/t8js/sdk-factory" target="_blank">GitHub</a> <span class="icon">✦</span></span>
</p>
</main>
<hr>
<nav class="aux">
<section>
<p class="title">Contents</p>
<ul><li data-id="RequestService"><a href="/sdk-factory/x/RequestService"><code>RequestService</code></a></li>
<li data-id="Schema_definition"><a href="/sdk-factory/x/Schema_definition">Schema definition</a></li>
<li data-id="Shorthand_methods"><a href="/sdk-factory/x/Shorthand_methods">Shorthand methods</a></li>
<li data-id="Custom_request_handler"><a href="/sdk-factory/x/Custom_request_handler">Custom request handler</a></li>
<li data-id="Schema-based_validation"><strong>Schema-based validation</strong></li>
</ul>
<p class="title">Resources</p>
<ul>
  <li><a href="https://github.com/t8js/sdk-factory" target="_blank">GitHub</a></li>
  <li><a href="https://www.npmjs.com/package/@t8/sdk-factory" target="_blank">npm</a></li>
</ul>
</section>
<section class="related">
  <p class="title">Also with vanilla TS/JS</p>
  <ul>
    <li><a href="/router" data-name="@t8/router">T8 <strong>Router</strong></a></li>
    <li><a href="/store" data-name="@t8/store">T8 <strong>Store</strong></a></li>
  </ul>
  <p class="title">With React</p>
  <ul>
    <li><a href="/react-router" data-name="@t8/react-router">T8 <strong>React Router</strong></a></li>
    <li><a href="/react-store" data-name="@t8/react-store">T8 <strong>React Store</strong></a></li>
    <li><a href="/react-pending" data-name="@t8/react-pending">T8 <strong>React Pending</strong></a></li>
  </ul>
</section>
</nav>
</div>
</div>
<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.11.1/styles/stackoverflow-light.min.css" media="(prefers-color-scheme: light)">
<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.11.1/styles/base16/material.min.css" media="(prefers-color-scheme: dark)">
<link rel="stylesheet" href="https://unpkg.com/@t8/docsgen@0.3/dist/css/code.css">
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.11.1/highlight.min.js"></script>
<script>hljs.highlightAll()</script>
<script src="/assets/stats.js"></script>
</body>
</html>
